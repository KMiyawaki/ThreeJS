<!DOCTYPE html>

<html>

<head>
    <title>Scene</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/110/three.min.js"></script>
    <script type="text/javascript" src="../js/ammo.js"></script>
    <script type="text/javascript" src="../js/myThree2020.js"></script>
    <script type="text/javascript" src="../js/myAmmo2020.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div id="screen"></div>
    <script type="text/javascript">
        function init() {
            Ammo(); // Add
            const SCREEN_W = window.innerWidth
            const SCREEN_H = window.innerHeight;
            const [scene, camera, renderer, clock, axes] = mylib2020.initThree(SCREEN_W, SCREEN_H);
            const physics = mylib2020.initAmmo(); // Add

            let plane = new THREE.Mesh(new THREE.PlaneGeometry(10, 10),
                new THREE.MeshLambertMaterial({ color: 0xcccccc }));
            let bbox = new THREE.Box3().setFromObject(plane);
            plane.rotation.x = THREE.Math.degToRad(-90);
            plane.receiveShadow = true;
            scene.add(plane);
            plane.userData.rigidBody = mylib2020.createAmmoBox(bbox, plane.position, plane.quaternion, 0);
            physics.addRigidBody(plane.userData.rigidBody);

            let sphere = new THREE.Mesh(new THREE.SphereGeometry(0.4, 20, 20),
                new THREE.MeshPhongMaterial({ color: 0x7777ff }));
            sphere.position.x = 0;
            sphere.position.y = 10;
            sphere.position.z = 0.5;
            sphere.castShadow = true;
            sphere.receiveShadow = true;
            scene.add(sphere);
            sphere.userData.rigidBody = mylib2020.createAmmoSphere(0.4, sphere.position, sphere.quaternion, 1);
            physics.addRigidBody(sphere.userData.rigidBody);

            let spotLight = new THREE.SpotLight(0xffffff);
            spotLight.position.set(0, 10, 0);
            spotLight.castShadow = true;
            scene.add(spotLight);

            document.getElementById("screen").appendChild(renderer.domElement);

            function renderFrame() {
                let deltaTime = clock.getDelta();
                physics.stepSimulation(deltaTime, 1); // Add
                mylib2020.applyAmmo(sphere.userData.rigidBody, sphere);

                renderer.render(scene, camera);
                requestAnimationFrame(renderFrame);
            }
            renderFrame();
        }
        window.onload = init;
    </script>
</body>

</html>